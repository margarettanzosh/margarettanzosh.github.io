<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
    
    <title>Protein Content Checker</title>
</head>
<body>
    <!-- Main page -->
    <div class="container">

        <ul class="nav justify-content-end">
            <li class="nav-item dropdown" style="font-size: .9em;">
                <a class="nav-link dropdown-toggle text-muted text-small" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Account</a>
                <ul class="dropdown-menu" style="font-size: .9em;">
                  <li><a id="account" class="dropdown-item" href="#">Account Into</a></li>
                  <li><a id="signOut" class="dropdown-item" href="#">Log Out</a></li>
                </ul>
            </li>
        </ul>

        <h1 class="text-center mt-4">Protein Tracker</h1>
        <select class="form-select" id="date"></select>

        <div class="form-outline mb-3">
            <input list="customFoods" type="search" id="customFoodChoice" class="form-control mt-4" autocomplete="off"/>
            <label class="form-label" for="customFoodChoice">Search for your food</label>
        </div>

        <div class="input-group mb-4" id="searchAdd">

            <!-- <input list="customFoods" type="search" class="form-control" id="customFoodChoice" placeholder="Search for your food" autocomplete="off" name="customFoodChoice" /> -->
            <button class="btn btn-outline-danger" type="button" id="addFoodHere">Add Your Own Food</button>
            <button class="btn btn-outline-danger" type="button" id="getNutrition">Search USDA</button>
        </div>

        <div id="nutritionalResult"></div>
        <div id="dailyNutrition"></div>
    </div>

     <!-- Modal for account info-->
     <div class="modal fade" id="accountInfoModal" tabindex="-1" aria-labelledby="accountInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                        <h5 class="modal-title">Account Info</h5>
                        <button type="button" id="closeNewFoodModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="mt-3 modal-body">
                    <p>You are signed in as <span id="accountEmail"></span></p>
                </div>
    
            </div>
        </div>
    </div>
    
    <!-- Modal for table of food choices-->
    <div class="modal fade" id="foodChoiceModal" tabindex="-1" aria-labelledby="foodChoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="form-outline" style="margin-right: 10px;">
                    <input type="text" id="usdaFoodChoice" class="form-control" autocomplete="off"/>
                    <label class="form-label" for="usdaFoodChoice">Search USDA Database</label>
                </div>
                <button type="button" id="usdaSearch" style="padding-top: 5px; padding-bottom: 5px;" class="btn text-light fa-lg gradient-custom-2">Enter</button>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-insert">
                    <!-- Table goes here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding your own food-->
    <div class="modal fade" id="addFoodModal" tabindex="-1" aria-labelledby="addFoodModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="addFoodModalLabel">Add a Food to Your Food List</h5>
            <button type="button" id="closeNewFoodModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="mt-3">

                <!--New Code -->
                <div style="padding: 20px;">
                    <form autocomplete="off">

                        <div class="form-outline mb-4">
                            <input type="text" id="newFoodName" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="newFoodName">Name of Food</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input type="number" id="newFoodServing" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="newFoodServing">Serving Size</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input list="myUnit" type="search" id="newFoodUnit" class="form-control mt-4" autocomplete="off"/>

                                <datalist id="myUnit">
                                    <option class="newFoodIndex" data-key="g" value="gram"></option>
                                    <option class="newFoodIndex" data-key="oz" value="Ounce"></option>
                                    <option class="newFoodIndex" data-key="tbsp" value="Tablespoon"></option>
                                    <option class="newFoodIndex" data-key="tsp" value="Teaspoon"></option>
                                    <option class="newFoodIndex" data-key="c" value="Cup"></option>
                                </datalist>
                            </input>
                            <label class="form-label" for="newFoodUnit">Serving Unit</label>
                        </div>

                        
                        <div class="form-outline mb-4">
                            <input type="text" id="newFoodProtein" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="newFoodProtein">Protein in Grams</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input type="text" id="newFoodCalories" class="form-control" autocomplete="off" />
                            <label class="form-label" for="newFoodCalories">Calories</label>
                        </div>

                        
                    </form>
                </div>
            
                <div class="modal-footer mb-0">
                    <div id="saveFoodAlert"></div>
                    <button type="button" class="btn btn-outline-danger" id="saveNewFood">Save</button>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- Modal for selecting your portion of your own food-->
    <div class="modal fade" id="chooseAmtModal" tabindex="-1" aria-labelledby="chooseAmtModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="chooseAmtModalLabel">Food Item Goes Here</h5>
            <button type="button" id="closeSelectModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="portion">


                <div class="input-group mt-4 mb-4">
                    <input type="number" class="form-control" id="foodServing" placeholder="Serving Size">
                    <select id="chooseFoodUnit" class="form-select" aria-label="Choose Serving Unit">
                        <option value="g">Grams</option>
                        <option value="oz">Ounces</option>
                        <option value="tbsp">Tablespoons</option>
                        <option value="tsp">Teaspoons</option>
                        <option value="c">Cups</option>
                    </select>
                </div>
        
                <div><p>Protein: <span id="chooseProtein">2</span></p></div>
                <div><p >Calories: <span id="chooseCalories">2</span></p></div>
            
                <div class="modal-footer mb-0">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal" id="chooseSave">Log Food</button>
                    <div id="saveUSDAButton"></div>
                </div>
            </div>
            
        </div>
        </div>
    </div>

   <!-- Modal for Log In -->
    <div class="modal fade" id="logInModal" tabindex="-1" aria-labelledby="logInModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modalPad" style="background-color: #eee;">
            <div class="modal-content" class="pl-5 pr-5">
                <h4 class="pt-5 pb-0 text-center" id="logInForm">Welcome to Protein Tracker</h4>
                
                <div style="padding: 40px;">
                    <form autocomplete="off" id="login">
                        <p>Please login to your account</p>

                        <div id="loginAlert"></div>

                        <div class="form-outline mb-4">
                            <input type="email" id="email" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="email">Email</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input type="password" id="pw" autocomplete="off" class="form-control" />
                            <label class="form-label" for="pw">Password</label>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-block text-light fa-lg gradient-custom-2" id="enterEmailPassword" type="button">Log in</button>
                            <a class="text-muted text-center mb-4" style="text-decoration: none;" href="#!">Forgot password?</a>
                        </div>

                        <div class="d-flex align-items-center justify-content-center pb-4">
                            <p class="me-2 mt-3">Don't have an account?</p>
                            <button type="button" id="register" class="btn btn-outline-danger">Create new</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Register -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modalPad" style="background-color: #eee;">
            <div class="modal-content" class="pl-5 pr-5">
                <h4 class="pt-5 pb-0 text-center" id="logInForm">Create an Account</h4>
                
                <div style="padding: 40px;">
                    <form autocomplete="off" id="loginNew">
                        <p>Please complete to create your account</p>
                        <div id="registerAlert"></div>


                        <div class="form-outline mb-4">
                            <input type="text" id="usernameNew" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="usernameNew">Username</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input type="email" id="emailNew" class="form-control" autocomplete="off"/>
                            <label class="form-label" for="emailNew">Email</label>
                        </div>

                        <div class="form-outline mb-4">
                            <input type="password" id="pwNew" autocomplete="off" class="form-control" />
                            <label class="form-label" for="pwNew">Password</label>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-block text-light fa-lg gradient-custom-2" id="createAccount" type="button">Register</button>
                            <a class="text-muted text-center mb-4" id="regToLogin" style="text-decoration: none;" href="#!">Login</a>
                        </div>

                        
                    </form>
                </div>
            </div>
        </div>
    </div>

    


    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script type="module">

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js';
        import { getDatabase, ref, push, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js';  

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAX325MD2r1qGTOXaSDBvUPgRrKOYzasG4",
            authDomain: "bones-2e7a7.firebaseapp.com",
            projectId: "bones-2e7a7",
            storageBucket: "bones-2e7a7.appspot.com",
            messagingSenderId: "820204450490",
            appId: "1:820204450490:web:fd928c5e2642bd7b6f8883",
            measurementId: "G-RBW5MHXRDM",
            databaseURL: "https://bones-2e7a7-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase app
        const firebase = initializeApp(firebaseConfig);

        // Initialize Firebase Authentication and Realtime Database
        const auth = getAuth(firebase);

        // const database = firebase.database();
        const database = getDatabase(firebase);

        // Declare reference
        let userRef, reference, foodRef, user, uid, email, foodKey, boost;

         // Modal variable to log in
         const newLogInModal = new bootstrap.Modal(document.getElementById('logInModal'), {
            backdrop: false
        })

        const newRegisterModal = new bootstrap.Modal(document.getElementById('registerModal'), {
            backdrop: false
        })

        const newAccountInfoModal = new bootstrap.Modal(document.querySelector('#accountInfoModal'), {
            backdrop: false
        })

        document.querySelector('#register').addEventListener('click', function() {
            newRegisterModal.show()
        })

        document.querySelector('#regToLogin').addEventListener('click', function() {
            newRegisterModal.hide()
            newLogInModal.show()
        })

        document.querySelector('#account').addEventListener('click', function() {
            document.querySelector('#accountEmail').innerHTML = email;
            newAccountInfoModal.show()
        })

        // const auth = getAuth();
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/auth.user
                uid = user.uid;
                email = user.email;
                userRef = ref(database, 'users/' + uid)
                reference = ref(database, 'users/' + uid + '/' + date);
                console.log('logged in as: ' + uid);
                newLogInModal.hide()
                document.querySelector('#customFoodChoice').innerHTML = "";
                accessData()
                accessCustomFood()
            } else {
                // User is signed out
                newLogInModal.show()
                console.log('no user');
            }
        });

        // Try logging in
        const loginEmailPassword = async () => {
            const loginEmail = document.querySelector('#email').value;
            const loginPassword = document.querySelector('#pw').value;
            const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword)
                .catch(function(error) {
                    let errorMsg;
                   
                    if (error.code === 'auth/invalid-credential') {
                        errorMsg = 'Incorrect email or password'
                    }
                    else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Invalid email'
                    }
                    else if (error.code === 'auth/missing-password') {
                        errorMsg = 'Missing password'
                    }
                    else {
                        errorMsg = error.code
                    }

                    document.querySelector('#loginAlert').innerHTML = 
                    `<div class="alert alert-danger alert-dismissible mb-4" style="height: 45px; padding-top: 10px" role="alert">
                        <div>${errorMsg}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="padding-top: 10px" aria-label="Close"></button>
                    </div>`
                })            
        }
        

        document.querySelector('#enterEmailPassword').addEventListener('click', loginEmailPassword);

        // Create New Usesr
        function register() {
            const userName = document.querySelector('#usernameNew').value;
            const loginEmail = document.querySelector('#emailNew').value;
            const loginPassword = document.querySelector('#pwNew').value;


            createUserWithEmailAndPassword(auth, loginEmail, loginPassword)
            .then((userCredential) => {

                // Signed up now add user to database
                user = userCredential.user;

                // database_ref = database.ref()
                userRef = ref(database, 'users/' + user.uid)

                const userData = {
                    username: userName,
                    email: loginEmail,
                    last_login: Date.now()
                }

                set(userRef, userData) 
  
                newRegisterModal.hide()
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode, errorMessage)
                document.querySelector('#registerAlert').innerHTML = 
                    `<div class="alert alert-danger alert-dismissible mb-4" style="height: 45px; padding-top: 10px" role="alert">
                        <div>${errorCode}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="padding-top: 10px" aria-label="Close"></button>
                    </div>`

            });
        }
        
        document.querySelector('#createAccount').addEventListener('click', register)    

        document.querySelector('#signOut').addEventListener('click', function() {
            signOut(auth).then(() => {
                // Sign-out successful.
                console.log('Logged Out');
                }).catch((error) => {
                // An error happened.
                console.log('error' + error);    
            });
        })

        // Get a reference to the database service
        let date = formatDate(new Date())
        // let reference = ref(database, 'users/' + user.uid + '/' + date);

        // API Key for USDA Data
        const apiKey = 'ay7l5f8rFfytKJXBzBjlxRWsZXpWfotBUc3JteGi'; 

        // Global variables
        let foodName, calories, protein, serving, unit, newFoodName, newUnit, newProtein, newCalories, newServing

        // Create modal variable
        const myModal = new bootstrap.Modal(document.getElementById('foodChoiceModal'), {
            backdrop: false
        })

        // Modal variable for saving food item
        const newFoodModal = new bootstrap.Modal(document.getElementById('addFoodModal'), {
            backdrop: false
        })

        // Modal variable to choose food units
        const newChooseModal = new bootstrap.Modal(document.getElementById('chooseAmtModal'), {
            backdrop: false
        })

       

        // Add event listener to the date select menu
        document.getElementById('date').addEventListener('change', function() {
            // Handle the change event here
            const selectedOption = document.getElementById('date').value;
            date = document.getElementById('date').value;
            reference = ref(database, 'users/' + uid + '/' + date);
            accessData()
        });

        // Add event listener to clear food choice when closing portion modal
        document.getElementById('closeSelectModal').addEventListener('click', function() {
            document.getElementById('customFoodChoice').value = '';
        })


        // Add event listener to add new food button on opening page
        document.getElementById('addFoodHere').addEventListener('click', function() {
            document.querySelector('#saveFoodAlert').innerHTML = '';
            newFoodModal.show()
        })


        // Add event listener to save button on new food modal
        document.getElementById('saveNewFood').addEventListener('click', function() {
            foodName = document.getElementById('newFoodName').value;
            serving = document.getElementById('newFoodServing').value;
            unit = document.getElementById('newFoodUnit').value;
            protein = document.getElementById('newFoodProtein').value;
            calories = document.getElementById('newFoodCalories').value;

            if (!foodName || !serving || !unit || !protein || !calories) {
                document.querySelector('#saveFoodAlert').innerHTML = 
                    `<div class="alert alert-danger alert-dismissible mt-3" style="height: 45px; padding-top: 10px" role="alert">
                        <div>Please complete to save</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="padding-top: 10px" aria-label="Close"></button>
                    </div>`

            }
            else {
                addFood({
                        food: foodName,
                        protein: protein,
                        calories: calories,
                        serving: serving,
                        unit: unit,
                        boost: 0
                    });
                newFoodModal.hide()    
                clearNewFoods();       
            }
        })

        document.getElementById('closeNewFoodModal').addEventListener('click', function() {
            clearNewFoods();
            document.getElementById('customFoodChoice').value = '';
        })

        // Function to clear new food modal
        function clearNewFoods() {
            document.getElementById('newFoodName').value = '';
            document.getElementById('newFoodServing').value = '';
            document.getElementById('newFoodUnit').value = '';
            document.getElementById('newFoodProtein').value = '';
            document.getElementById('newFoodCalories').value = '';        
        }

        
        // Function to store food log data in Firebase
        function storeData(data) {
            // Push data to a specific location in the database
            // reference = ref(database, 'user/margaret/' + date);
            reference = ref(database, 'users/' + uid + '/' + date)
            const newPostRef = push(reference);
            set(newPostRef, data)
            .then(() => {
            // Data saved successfully!
            console.log("Data Saved!")
            })
            .catch((error) => {
            // The write failed...
            console.log(error)
            });
        }

         // Function to store your own food item in database
         function addFood(item) {
            foodRef = ref(database, 'users/' + uid + '/foodItems');
            const newFoodRef = push(foodRef);
            set(newFoodRef, item)
            .then(() => {
            // Data saved successfully!
            console.log("Data Saved!")
            })
            .catch((error) => {
            // The write failed...
            console.log(error)
            });
        }

        // Function to remove data from Firebase
        function removeData(referencePath) {
            // Get reference to the data to be removed
            let dataRef = ref(database, referencePath);

            // Remove the data
            return remove(dataRef)
                .then(() => {
                    console.log('Data removed successfully');
                })
                .catch((error) => {
                    console.log('Error removing data:', error);
                });
        }

        // Function to create datalist for your own food items
        function accessCustomFood() {
            foodRef = ref(database, 'users/' + uid + '/foodItems');
            onValue(foodRef, (snapshot) => {
                const data = snapshot.val();
                
                // Check for new user with no data
                if (!data) {
                    return;
                }

                // Sorting for most popular first
                const foods = Object.entries(data)
                foods.sort((a,b) => { if (parseInt(a[1].boost) > parseInt(b[1].boost)) {return -1} else if (parseInt(a[1].boost) < parseInt(b[1].boost)) {return 1} else {return 0}})    

                let foodTable = `<datalist id="customFoods">`;
                for (const food of foods) {
                    // console.log(food)
                    foodTable += `<option class="newFoodIndex" data-key="${food[0]}" value="${food[1].food}"></option>`
                }
                foodTable += `</datalist>`;
                document.getElementById('customFoodChoice').innerHTML = foodTable;

                $('#customFoodChoice').keyup(function(event) {
                    foodName = $(this).val();
                    let key = $('#customFoods [value="' + foodName + '"]').data('key');
                    if (key) {
                        document.getElementById('chooseAmtModalLabel').innerHTML = foodName;
                        newChooseModal.show()

                        foodRef = ref(database, 'users/' + uid + '/foodItems' + '/' + key);

                        onValue(foodRef, (snapshot) => {
                            const data = snapshot.val();
                            // console.log(data)
                            document.getElementById('chooseProtein').innerHTML = data.protein + " g";
                            document.getElementById('chooseCalories').innerHTML = data.calories + " cal"

                            // Change select menu
                            $("#chooseFoodUnit").val(data.unit);

                            document.getElementById("foodServing").value = data.serving;
                            serving = document.getElementById("foodServing").value;
                            protein = data.protein;
                            calories = data.calories;
                            newProtein = (serving / data.serving * data.protein).toFixed();
                            newCalories = (serving / data.serving * data.calories).toFixed();
                            unit = data.unit;  
                            foodKey = key; 
                            boost = data.boost;    
                        })
                    }
                });
            }
        )}

        // Event listener to change protein and calories when serving amount changes
        document.getElementById("foodServing").addEventListener("change", function() {
            newServing = document.getElementById("foodServing").value;
            
            newProtein = (newServing / serving * protein).toFixed();
            newCalories = (newServing / serving * calories).toFixed();

            document.getElementById('chooseProtein').innerHTML = newProtein + " g";
            document.getElementById('chooseCalories').innerHTML = newCalories + " cal";
            protein = newProtein;
            calories = newCalories;
            serving = newServing;
        }) 
        
        // Event listener to change serving size when unit changes
        document.getElementById('chooseFoodUnit').addEventListener("change", function() {
            newUnit = document.getElementById('chooseFoodUnit').value;
            serving = document.getElementById("foodServing").value;

            if (unit == 'g') {
                if (newUnit == 'oz') {
                    newServing = serving / 28.35;
                }
                else if (newUnit == 'c') {
                    newServing = serving / 237;
                }
                else if (newUnit == 'tbsp') {
                    newServing = serving / 4.18;
                }
                else if (newUnit == 'tsp') {
                    newServing = serving / 4.725;
                }
            }

            if (unit == 'oz') {
                if (newUnit == 'g') {
                    newServing = serving * 28.35;
                }
                else if (newUnit == 'c') {
                    newServing = serving / 8;
                }
                else if (newUnit == 'tbsp') {
                    newServing = serving * 2;
                }
                else if (newUnit == 'tsp') {
                    newServing = serving * 6;
                }
            }

            if (unit == 'c') {
                if (newUnit == 'g') {
                    newServing = serving * 237; // ???
                }
                else if (newUnit == 'oz') {
                    newServing = serving * 8;
                }
                else if (newUnit == 'tbsp') {
                    newServing = serving * 16;
                }
                else if (newUnit == 'tsp') {
                    newServing = serving * 48;
                }
            }

            if (unit == 'tbsp') {
                if (newUnit == 'g') {
                    newServing = serving * 14.175; // ???
                }
                else if (newUnit == 'oz') {
                    newServing = serving / 2;
                }
                else if (newUnit == 'c') {
                    newServing = serving / 16;
                }
                else if (newUnit == 'tsp') {
                    newServing = serving * 3;
                }
            }

            if (unit == 'tsp') {
                if (newUnit == 'g') {
                    newServing = serving * 5.69; // ???
                }
                else if (newUnit == 'oz') {
                    newServing = serving / 6;
                }
                else if (newUnit == 'c') {
                    newServing = serving / 48;
                }
                else if (newUnit == 'tsp') {
                    newServing = serving / 3;
                }
            }

            serving = newServing;
            unit = newUnit;
            document.getElementById('foodServing').value = serving;
        })

        // Event listener to save new food
        document.getElementById('chooseSave').addEventListener('click', function () {
  
            storeData({
                food: foodName,
                protein: protein,
                calories: calories,
                serving: serving,
                unit: unit,
            });

            // Also update boost for this food item
            boost++
            update(foodRef, {boost: boost})


            document.getElementById('customFoodChoice').value = "";
            accessData()
        })
  


        // Get daily data from db and display
        function accessData() {
            // reference = ref(database, 'users/' + user.uid + '/' + date);
            onValue(reference, (snapshot) => {
                let calories = 0;
                let protein = 0;
                let dailyTotals = `<table class="table table-hover table-sm"><thead><tr><th scope="col">Item Name</th><th scope="col" class="text-end">Amt</th><th scope="col" class="text-end">Protein</th><th scope="col" class="text-end">Cal</th></tr></thead>`

                const data = snapshot.val();
                
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        let units = "oz"
                        if (data[key].unit) {
                            units = data[key].unit;
                        }
                        dailyTotals += `<tr><td class="text-truncate">${data[key].food}</td><td class="text-end">${data[key].serving} ${units}</td><td class="text-end">${data[key].protein} g</td><td class="text-end">${data[key].calories} cal</td><td class="text-end" style="max-width: 50px;"><span data-id=${key} class="close">&times;</span></td></tr>`
                        protein += parseInt(data[key].protein)
                        calories += parseInt(data[key].calories)
                    }
                }
                dailyTotals += `<tr><th>Daily Totals</td><td></th><th class="text-end">` + protein + ` g </th><th class="text-end">` + calories + ` cal</th>`
                dailyTotals += `</table>`
                document.getElementById("dailyNutrition").innerHTML = dailyTotals

                // Add event listener to close buttons
                let closebtns = document.getElementsByClassName("close");
                for (let i = 0; i < closebtns.length; i++) {
                    closebtns[i].addEventListener("click", function() {
                        const referencePath = `users/${uid}/${date}/${this.dataset.id}`;
                        // Remove data from Firebase
                        removeData(referencePath)
                            .then(() => {
                                // Once data is successfully removed, update the UI
                                accessData();
                            });
                        });
                }
            })
            
        }

        document.getElementById('getNutrition').addEventListener('click', function() {
            document.getElementById('usdaFoodChoice').value = '';
            document.getElementById('modal-insert').innerHTML = '';
            myModal.show();
        })


        // Click event listener for the button ?????
        document.getElementById('usdaSearch').addEventListener('click', async () => {
            foodName = document.getElementById('usdaFoodChoice').value;
            
            try {
                const nutritionalInfo = await fetchNutritionalInfo(foodName);
            }   
            catch (error) {
                console.log('Line 168: Error fetching nutritional information:', error);
            }
            document.getElementById('customFoodChoice').value = "";
        });

        // Function to fetch nutritional information from USDA API
        async function fetchNutritionalInfo(foodName) {
            const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(foodName)}&api_key=${apiKey}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.foods && data.foods.length > 0) {

                    let foodTable = `<table class="table table-hover table-sm">`;  
                    for (let i = 0; i < data.foods.length; i++) {
                        foodTable += `<tr class="foodIndex"><td>${data.foods[i].description}</td><td>${data.foods[i].brandName || data.foods[i].additionalDescriptions}</td></tr>`
                    }
                    foodTable += `</table>`;
                    document.getElementById('modal-insert').innerHTML = foodTable;
                    // myModal.show();

                    let modalRows = document.getElementsByClassName("foodIndex");
                    for (let i = 0; i < modalRows.length; i++) {
                        modalRows[i].addEventListener("click", function() {
                            myModal.hide();

                            fetchNutrients(data.foods[i].fdcId);
                        });
                    }
                } 
            }
            catch (error) {
                    console.log('Line 203: Error fetching food data:', error);
            }
        }

        // Function to fetch nutrients from USDA API and save to db
        async function fetchNutrients(foodId) {
            const url = `https://api.nal.usda.gov/fdc/v1/food/${foodId}?format=abridged&nutrients=203&nutrients=208&api_key=${apiKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
            
                if (data.foodNutrients && data.foodNutrients.length > 0) {
                    const nutrients = {};
                    data.foodNutrients.forEach(nutrient => {
                        nutrients[nutrient.name.toLowerCase()] = nutrient.amount;
                    });

                    // Calculate protein and calories based on serving size
                    // let ounces = 1; // assumne one ounce serving to start
                    // const servingSize = 28.3495 * ounces; // Convert oz to grams
                    const proteinPer100g = nutrients.protein || 0;
                    // const proteinPerServing = (proteinPer100g / 100) * servingSize;
                    const caloriesPer100g = nutrients.energy || 0; // Assuming energy represents calories
                    // const caloriesPerServing = (caloriesPer100g / 100) * servingSize;
                    serving = 100;

                    // Open modal to modify servings here
                    document.getElementById('saveUSDAButton').innerHTML = `<button type="button" id="saveUSDAFood" class="btn btn-outline-danger">Save to My Foods</button>`
                    newChooseModal.show()

                    document.getElementById('chooseProtein').innerHTML = proteinPer100g + " g";
                    document.getElementById('chooseCalories').innerHTML = caloriesPer100g + " cal"

                    // Change select menu
                    $("#chooseFoodUnit").val("g");

                    document.getElementById("foodServing").value = serving;
                    // originalServing = document.getElementById("foodServing").value;
                    protein = proteinPer100g;
                    calories = caloriesPer100g;
                    unit = 'g';
                    document.getElementById('chooseAmtModalLabel').innerHTML = data.description;
                    foodName = data.description

                    // Event listener to save USDA food
                    document.getElementById('saveUSDAFood').addEventListener('click', function() {
                        newChooseModal.hide()
                        newFoodModal.show()
                        document.getElementById('saveUSDAButton').innerHTML = '';

                        document.getElementById('newFoodName').value = foodName;
                        document.getElementById('newFoodServing').value = serving;
                        document.getElementById('newFoodUnit').value = unit;
                        document.getElementById('newFoodProtein').value = protein;
                        document.getElementById('newFoodCalories').value = calories;
                        
                    })
            

                    } else {
                        document.getElementById('nutritionalResult').innerText = 'Error fetching nutritional information.';
                    }
                } 
                catch {
                    throw new Error('Nutritional information not found.');
                }
        
        }

        // Function to generate dates for a specific range
        function generateDates(startDate) {
            const dates = [];
            let currentDate = startDate;

            for (let i = 0; i < 7; i++) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return dates;
        }

        // Function to format date as "Tuesday, Apr 30, 2024"
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Get the dropdown element
        const dateDropdown = document.getElementById("date");

        // Generate dates for a specific range (e.g., a month)
        const startDate = new Date();
        const dates = generateDates(startDate);

        // Populate the dropdown with formatted dates
        dates.forEach(date => {
            const option = document.createElement("option");
            option.textContent = formatDate(date);
            dateDropdown.appendChild(option);
        });

        const element = document.querySelector('form');
        element.addEventListener('submit', event => {
            event.preventDefault();
            // actual logic, e.g. validate the form
            console.log('Form submission cancelled.');
        });


    </script>
    <script type="text/javascript" src="login.js"></script>
</body>
</html>
